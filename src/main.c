/************************************************************************************
 * 	
 * 	@file     main.c
 *  @author   Mario Lanzilotta
 * 	@brief    Continuous blood pressure monitor code for nrf52840dk
 *  
************************************************************************************/

#include <inttypes.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include <zephyr/device.h>
#include <zephyr/devicetree.h>
#include <zephyr/drivers/adc.h>
#include <zephyr/kernel.h>
#include <zephyr/sys/printk.h>
#include <zephyr/sys/util.h>
#include <zephyr/logging/log.h>
#include <zephyr/drivers/spi.h>
#include <zephyr/drivers/gpio.h>

#include "../drivers/sensor_ppg.h"
#include "bpm.h"
#include "../lib/cross_correlate.h"

#include <zephyr/bluetooth/bluetooth.h>
#include <zephyr/bluetooth/conn.h>
#include <zephyr/bluetooth/gatt.h>
#include <zephyr/settings/settings.h>

#define USE_TEST_DATA (1)

//Initialize Logger
LOG_MODULE_REGISTER(bp, LOG_LEVEL_DBG);

//Stacksize for threads
#define STACKSIZE 2048

//Size of proximal and distal arrays, number of samples taken per cycle
#define PPG_ARRAY_SIZE 2000
//Size of coefficients array, maximum PTT if divided by sample rate
#define MAX_PTT 100
//Sampling rate of PPG sensors (in Hz)
#define PPG_SAMPLE_RATE 1000
//Time between sensor read cycles
#define SENSOR_SLEEP_MS 1000

//Thread priorities
#define READ_THREAD_PRIORITY 1
#define CALC_THREAD_PRIORITY 2

#define CS_NODE DT_ALIAS(ppgcs)
#define CS_NODE2 DT_ALIAS(ppgcs2)

#define SPI_PPG_OP SPI_OP_MODE_MASTER | SPI_MODE_CPOL | SPI_MODE_CPHA | SPI_WORD_SET(8) | SPI_LINES_SINGLE | SPI_TRANSFER_MSB 

static const struct spi_dt_spec spi_ppg_dist = SPI_DT_SPEC_GET(DT_NODELABEL(adpd1801), SPI_PPG_OP, 0);
static const struct spi_dt_spec spi_ppg_prox = SPI_DT_SPEC_GET(DT_NODELABEL(adpd18012), SPI_PPG_OP, 0);

static const struct gpio_dt_spec ppg_csd = GPIO_DT_SPEC_GET(CS_NODE, gpios);
static const struct gpio_dt_spec ppg_csp = GPIO_DT_SPEC_GET(CS_NODE2, gpios);

static uint32_t proximal[PPG_ARRAY_SIZE] = {9817,9816,9818,9820,9814,9826,9823,9821,9821,9824,9821,9824,9823,9829,9827,9824,9823,9820,9829,9825,9824,9824,9825,9823,9830,9825,9827,9826,9828,9830,9829,9830,9824,9831,9826,9831,9833,9828,9832,9832,9827,9831,9831,9826,9828,9832,9828,9824,9829,9832,9832,9832,9829,9837,9829,9835,9831,9827,9833,9833,9832,9834,9833,9834,9835,9836,9828,9829,9835,9832,9826,9823,9828,9831,9829,9834,9833,9829,9829,9819,9826,9829,9827,9823,9827,9829,9825,9823,9829,9824,9821,9823,9824,9816,9824,9825,9829,9825,9824,9824,9827,9823,9821,9822,9813,9824,9818,9816,9812,9817,9820,9818,9817,9825,9819,9818,9812,9816,9820,9814,9816,9809,9808,9815,9815,9814,9807,9814,9812,9809,9815,9810,9813,9806,9813,9809,9812,9810,9811,9810,9806,9808,9804,9808,9807,9802,9803,9806,9800,9806,9807,9808,9803,9801,9805,9802,9796,9808,9798,9805,9802,9798,9802,9801,9798,9802,9801,9798,9799,9803,9801,9796,9798,9800,9802,9801,9801,9797,9795,9798,9797,9793,9798,9797,9801,9797,9804,9802,9801,9798,9797,9792,9800,9791,9797,9795,9797,9800,9797,9798,9800,9803,9794,9796,9796,9795,9800,9795,9803,9799,9793,9795,9797,9798,9798,9800,9795,9787,9792,9804,9802,9799,9790,9792,9793,9796,9789,9794,9794,9800,9802,9800,9796,9795,9798,9801,9802,9797,9801,9796,9799,9798,9796,9797,9799,9794,9797,9796,9795,9800,9795,9797,9794,9802,9805,9802,9803,9803,9794,9799,9794,9794,9797,9801,9799,9797,9796,9800,9794,9798,9795,9800,9795,9796,9794,9797,9793,9803,9795,9797,9795,9794,9798,9799,9802,9801,9802,9799,9798,9801,9798,9793,9800,9793,9795,9795,9798,9799,9795,9801,9799,9793,9795,9804,9797,9797,9794,9796,9800,9799,9790,9794,9798,9795,9794,9795,9796,9794,9796,9792,9797,9798,9792,9795,9794,9797,9802,9800,9795,9797,9796,9792,9790,9791,9793,9794,9797,9797,9797,9790,9790,9790,9794,9796,9794,9792,9786,9797,9794,9794,9788,9791,9791,9796,9793,9789,9790,9789,9793,9797,9796,9796,9795,9793,9797,9796,9795,9795,9794,9787,9792,9796,9801,9798,9792,9790,9793,9794,9794,9796,9788,9797,9798,9791,9800,9793,9796,9794,9800,9795,9789,9793,9798,9798,9795,9802,9797,9794,9790,9793,9799,9792,9800,9800,9799,9795,9801,9797,9797,9796,9798,9794,9798,9797,9799,9797,9802,9796,9797,9797,9801,9794,9796,9799,9794,9799,9800,9800,9801,9801,9798,9789,9799,9796,9803,9800,9801,9799,9800,9801,9797,9798,9803,9801,9797,9798,9799,9803,9800,9805,9805,9799,9804,9802,9799,9799,9802,9806,9804,9802,9804,9796,9807,9805,9805,9797,9804,9802,9809,9807,9804,9806,9804,9802,9805,9803,9808,9802,9808,9808,9804,9807,9805,9810,9809,9813,9810,9809,9808,9805,9810,9810,9811,9806,9810,9807,9812,9809,9811,9808,9813,9810,9812,9802,9807,9810,9811,9812,9813,9809,9815,9817,9809,9809,9811,9812,9806,9807,9814,9817,9813,9811,9814,9809,9814,9815,9816,9811,9815,9815,9807,9813,9817,9818,9812,9812,9817,9814,9812,9820,9814,9811,9816,9813,9813,9818,9821,9813,9817,9818,9814,9810,9817,9816,9821,9813,9817,9816,9819,9824,9821,9819,9818,9819,9814,9815,9827,9822,9824,9818,9818,9820,9819,9822,9819,9817,9819,9822,9820,9823,9823,9823,9817,9823,9822,9823,9823,9815,9825,9822,9824,9822,9822,9829,9825,9821,9817,9815,9821,9818,9827,9825,9832,9823,9823,9829,9826,9832,9826,9822,9826,9827,9825,9820,9825,9827,9830,9825,9824,9828,9826,9829,9825,9829,9829,9828,9826,9826,9826,9832,9837,9828,9828,9832,9835,9832,9831,9834,9828,9830,9826,9832,9833,9839,9831,9831,9831,9833,9830,9839,9836,9836,9832,9835,9835,9836,9829,9835,9835,9831,9838,9834,9835,9834,9838,9843,9844,9840,9836,9835,9840,9840,9838,9837,9839,9842,9840,9843,9839,9838,9846,9840,9841,9839,9838,9838,9837,9840,9845,9840,9849,9845,9849,9854,9846,9849,9843,9848,9842,9844,9840,9848,9849,9845,9844,9845,9849,9843,9841,9843,9848,9851,9848,9856,9850,9849,9848,9854,9849,9853,9850,9851,9850,9855,9852,9855,9855,9849,9852,9849,9849,9854,9856,9852,9853,9850,9851,9849,9849,9852,9849,9855,9848,9853,9854,9846,9848,9850,9843,9850,9843,9844,9847,9852,9845,9846,9844,9842,9843,9846,9844,9846,9844,9843,9831,9840,9841,9843,9843,9840,9844,9842,9845,9842,9842,9844,9838,9838,9837,9840,9842,9840,9840,9833,9835,9834,9839,9846,9836,9832,9837,9836,9831,9828,9836,9834,9832,9830,9838,9835,9832,9829,9830,9826,9829,9829,9831,9825,9832,9827,9828,9826,9829,9826,9827,9827,9821,9824,9821,9830,9817,9823,9827,9820,9823,9824,9822,9825,9826,9819,9822,9820,9827,9823,9820,9820,9825,9823,9821,9822,9825,9824,9820,9814,9816,9823,9814,9820,9818,9820,9825,9819,9820,9818,9817,9821,9818,9822,9816,9812,9815,9816,9818,9817,9820,9817,9819,9815,9817,9818,9819,9812,9813,9810,9816,9818,9816,9814,9820,9819,9819,9814,9821,9813,9816,9815,9817,9816,9814,9814,9814,9815,9817,9815,9815,9814,9820,9817,9815,9817,9812,9818,9820,9814,9820,9817,9815,9821,9813,9815,9815,9815,9817,9821,9810,9815,9811,9815,9818,9817,9812,9812,9811,9815,9813,9822,9818,9809,9810,9811,9815,9816,9816,9820,9820,9816,9819,9816,9821,9815,9818,9811,9818,9820,9809,9821,9816,9817,9811,9812,9813,9813,9814,9815,9814,9814,9817,9813,9807,9813,9814,9817,9810,9816,9815,9808,9815,9811,9811,9809,9814,9810,9813,9818,9812,9816,9814,9811,9812,9809,9809,9810,9808,9803,9812,9811,9807,9812,9813,9808,9814,9810,9805,9806,9812,9816,9809,9808,9810,9814,9814,9818,9816,9814,9808,9802,9805,9811,9805,9804,9811,9810,9809,9806,9810,9806,9814,9806,9803,9805,9812,9813,9805,9811,9807,9811,9810,9804,9806,9815,9808,9810,9805,9805,9809,9807,9813,9810,9813,9806,9809,9809,9811,9812,9814,9810,9808,9806,9810,9810,9811,9810,9811,9813,9812,9810,9810,9807,9805,9804,9808,9810,9806,9812,9808,9813,9811,9816,9806,9813,9816,9804,9811,9809,9805,9811,9807,9814,9811,9808,9809,9809,9808,9818,9809,9812,9820,9809,9808,9805,9815,9808,9809,9813,9813,9815,9815,9816,9813,9814,9816,9814,9810,9813,9816,9813,9814,9814,9811,9814,9815,9819,9814,9815,9816,9819,9815,9816,9818,9815,9810,9817,9816,9818,9817,9822,9820,9814,9812,9814,9817,9821,9818,9821,9817,9817,9819,9816,9818,9825,9820,9818,9813,9819,9818,9817,9822,9832,9818,9822,9823,9816,9822,9826,9823,9820,9825,9822,9824,9823,9822,9825,9826,9830,9822,9818,9830,9827,9822,9820,9826,9825,9833,9826,9822,9827,9819,9827,9824,9825,9825,9830,9827,9820,9821,9816,9825,9830,9827,9827,9824,9828,9824,9829,9824,9827,9824,9822,9827,9831,9824,9829,9825,9826,9826,9831,9827,9831,9828,9830,9831,9829,9828,9834,9828,9830,9832,9827,9827,9824,9831,9831,9832,9832,9831,9831,9833,9828,9835,9832,9831,9829,9824,9837,9832,9835,9830,9837,9838,9836,9827,9834,9831,9836,9831,9836,9839,9834,9837,9835,9835,9838,9837,9835,9830,9835,9836,9841,9839,9838,9843,9834,9843,9836,9837,9834,9834,9833,9838,9838,9843,9835,9838,9840,9841,9834,9840,9841,9841,9839,9836,9838,9838,9835,9840,9839,9845,9844,9839,9847,9847,9847,9842,9843,9839,9836,9839,9849,9840,9844,9842,9846,9843,9842,9844,9847,9845,9845,9842,9847,9839,9847,9849,9846,9847,9844,9839,9841,9845,9845,9855,9848,9847,9842,9851,9850,9853,9849,9850,9847,9847,9844,9851,9850,9848,9852,9853,9855,9843,9849,9852,9846,9848,9849,9850,9854,9855,9856,9849,9854,9847,9851,9854,9850,9856,9857,9855,9856,9855,9844,9852,9857,9860,9859,9849,9855,9852,9857,9861,9858,9854,9855,9857,9860,9855,9863,9863,9854,9857,9858,9857,9863,9854,9859,9863,9859,9864,9860,9862,9869,9859,9860,9856,9859,9862,9863,9861,9867,9862,9864,9856,9861,9868,9869,9868,9865,9869,9865,9864,9865,9867,9871,9868,9862,9865,9866,9866,9866,9866,9865,9871,9868,9868,9874,9871,9870,9876,9869,9865,9872,9874,9875,9866,9868,9874,9875,9876,9870,9874,9873,9872,9869,9871,9867,9873,9868,9875,9877,9871,9871,9873,9865,9874,9871,9870,9876,9874,9875,9874,9874,9877,9866,9870,9872,9872,9873,9870,9864,9865,9867,9867,9868,9871,9865,9861,9871,9861,9865,9868,9868,9868,9864,9865,9869,9863,9867,9863,9863,9862,9869,9869,9862,9865,9859,9867,9862,9856,9864,9862,9861,9863,9857,9858,9860,9856,9859,9858,9859,9856,9853,9855,9854,9857,9855,9854,9847,9851,9853,9855,9851,9853,9850,9851,9852,9844,9855,9854,9854,9855,9852,9848,9849,9846,9848,9852,9852,9849,9851,9846,9846,9846,9849,9841,9850,9842,9850,9851,9848,9845,9843,9843,9845,9842,9844,9851,9844,9849,9844,9843,9845,9843,9846,9840,9847,9844,9843,9841,9844,9846,9846,9839,9837,9841,9835,9845,9843,9841,9840,9839,9847,9839,9840,9836,9840,9840,9845,9839,9841,9839,9836,9831,9837,9837,9843,9838,9844,9846,9841,9837,9830,9839,9833,9843,9838,9841,9838,9837,9838,9840,9842,9840,9842,9843,9839,9838,9838,9841,9842,9839,9837,9842,9838,9843,9844,9842,9835,9836,9833,9847,9839,9836,9836,9847,9842,9837,9838,9846,9842,9841,9845,9841,9837,9837,9836,9843,9838,9842,9841,9840,9837,9836,9846,9839,9844,9834,9839,9836,9845,9845,9837,9843,9841,9839,9837,9842,9842,9837,9844,9841,9844,9843,9843,9835,9844,9842,9833,9838,9842,9838,9849,9842,9841,9838,9841,9842,9844,9834,9838,9837,9840,9841,9840,9836,9839,9843,9839,9835,9841,9834,9840,9835,9837,9835,9836,9841,9841,9841,9836,9833,9834,9832,9843,9840,9839,9840,9834,9833,9832,9836,9839,9836,9834,9829,9836,9839,9835,9841,9841,9837,9842,9834,9836,9837,9834,9841,9841,9834,9839,9831,9839,9836,9841,9835,9844,9834,9834,9831,9838,9841,9832,9837,9833,9834,9833,9837,9840,9836,9834,9836,9835,9837,9833,9835,9846,9836,9838,9832,9837,9839,9840,9837,9834,9834,9837,9841,9840,9836,9831,9835,9834,9839,9840,9837,9841,9835,9838,9839,9837,9841,9839,9836,9840,9842,9837,9839,9836,9836,9837,9843,9838,9835,9837,9840,9850,9837,9833,9845,9843,9838,9841,9841,9838,9843,9838,9845,9841,9839,9848,9841,9844,9841,9846,9847,9843,9842,9846,9838,9840,9846,9843,9848,9848,9844,9841,9843,9841,9845,9846,9845,9846,9845,9841,9847,9848,9850,9851,9842,9844,9841,9845,9845,9848,9848,9850,9846,9848,9843,9854,9850,9848,9846,9842,9847,9848,9847,9844,9853,9843,9850,9850,9847,9849,9855,9849,9848,9850,9849,9848,9851,9854,9853,9848,9848,9849,9854,9851,9850,9856,9856,9851,9850,9851,9858,9855,9848,9855,9854,9852,9853,9854,9854,9860,9856,9854,9852,9855,9857,9850,9857,9859,9854,9852,9855,9854,9857,9858,9856,9854,9855,9856,9861,9852,9853,9859,9855,9854,9862,9860,9858,9856,9855,9859,9857,9864,9862,9863,9859,9853,9853,9863,9860,9865,9863,9863,9857,9862,9859,9864,9862,9860,9857,9863,9858,9854,9869,9864,9856,9864,9868,9866,9865,9865,9864,9867,9860,9861,9867,9861,9869,9869,9864,9861,9866,9866,9860,9863,9863,9862,9866,9863,9864,9865,9867,9865,9865,9867,9865,9865,9870,9868,9869,9864,9873,9867,9868,9869,9871,9869,9866,9866};
static uint32_t distal[PPG_ARRAY_SIZE] = {13332,13327,13337,13336,13336,13336,13336,13322,13332,13332,13330,13337,13339,13341,13334,13334,13334,13329,13339,13333,13338,13338,13334,13333,13338,13339,13344,13345,13333,13345,13348,13342,13339,13343,13341,13337,13340,13343,13343,13343,13350,13344,13342,13347,13352,13343,13347,13350,13347,13344,13345,13347,13346,13346,13349,13345,13343,13347,13346,13339,13346,13347,13348,13349,13348,13343,13349,13344,13350,13336,13347,13348,13343,13340,13347,13342,13337,13341,13338,13342,13343,13342,13343,13337,13342,13337,13338,13337,13336,13343,13333,13339,13331,13338,13342,13336,13334,13333,13327,13331,13330,13338,13334,13337,13324,13335,13329,13331,13329,13328,13325,13317,13318,13325,13327,13330,13322,13320,13324,13319,13312,13324,13318,13318,13312,13319,13319,13318,13309,13314,13310,13310,13312,13315,13313,13307,13312,13319,13305,13306,13310,13305,13309,13303,13309,13311,13301,13306,13305,13310,13310,13307,13306,13301,13300,13303,13304,13303,13307,13307,13301,13300,13301,13295,13303,13306,13294,13305,13305,13300,13297,13302,13303,13302,13296,13295,13301,13300,13302,13307,13300,13300,13303,13298,13303,13301,13298,13296,13300,13297,13300,13299,13307,13300,13298,13299,13299,13299,13300,13306,13302,13297,13301,13298,13298,13297,13304,13302,13288,13299,13299,13295,13298,13301,13299,13303,13299,13297,13298,13304,13303,13299,13296,13308,13302,13302,13296,13304,13304,13301,13297,13302,13303,13302,13291,13296,13306,13295,13298,13308,13299,13297,13295,13296,13301,13306,13303,13305,13300,13298,13299,13295,13303,13303,13302,13303,13303,13297,13303,13302,13302,13309,13302,13307,13295,13304,13296,13306,13299,13300,13299,13296,13295,13303,13299,13306,13302,13302,13302,13301,13303,13300,13301,13296,13299,13299,13297,13304,13303,13304,13306,13292,13302,13300,13297,13298,13305,13300,13300,13300,13299,13305,13303,13297,13300,13303,13298,13293,13298,13300,13307,13300,13300,13303,13293,13297,13299,13298,13296,13295,13300,13302,13295,13305,13301,13306,13290,13293,13300,13307,13299,13297,13296,13295,13301,13295,13295,13296,13302,13298,13293,13296,13296,13300,13295,13306,13300,13295,13296,13288,13300,13297,13299,13293,13295,13298,13297,13306,13302,13289,13290,13302,13292,13293,13305,13298,13302,13295,13296,13294,13298,13306,13307,13297,13299,13297,13299,13294,13299,13300,13296,13295,13294,13295,13298,13298,13299,13298,13297,13299,13299,13298,13303,13301,13298,13298,13296,13299,13297,13304,13299,13295,13297,13301,13293,13298,13301,13298,13302,13294,13296,13298,13306,13302,13300,13297,13309,13301,13295,13297,13301,13306,13301,13298,13301,13301,13306,13304,13307,13308,13303,13304,13302,13301,13306,13307,13304,13300,13299,13313,13311,13319,13310,13308,13303,13303,13312,13309,13315,13306,13304,13305,13308,13304,13313,13303,13304,13306,13309,13306,13308,13315,13313,13304,13304,13305,13305,13309,13306,13304,13302,13310,13308,13306,13303,13315,13312,13310,13306,13303,13308,13308,13309,13303,13308,13311,13305,13303,13310,13309,13311,13307,13309,13304,13311,13311,13323,13309,13306,13308,13315,13312,13315,13318,13316,13314,13309,13312,13310,13315,13317,13320,13316,13308,13320,13313,13319,13317,13318,13322,13317,13322,13318,13313,13328,13316,13319,13311,13315,13322,13320,13325,13320,13315,13321,13313,13325,13324,13315,13318,13319,13314,13315,13316,13321,13321,13323,13323,13320,13317,13321,13321,13320,13323,13316,13318,13323,13316,13327,13323,13323,13321,13324,13329,13320,13320,13329,13321,13325,13331,13322,13326,13328,13320,13324,13322,13330,13329,13321,13324,13325,13331,13326,13322,13328,13334,13331,13332,13325,13325,13326,13335,13331,13332,13324,13329,13333,13332,13332,13331,13327,13331,13325,13326,13328,13333,13327,13331,13330,13327,13325,13325,13332,13331,13333,13336,13321,13333,13331,13331,13343,13338,13336,13325,13325,13333,13328,13332,13336,13333,13328,13331,13334,13331,13332,13334,13337,13338,13337,13334,13331,13338,13340,13330,13332,13342,13334,13335,13342,13339,13340,13346,13336,13339,13341,13348,13342,13336,13342,13339,13341,13342,13351,13337,13338,13342,13345,13343,13350,13346,13343,13345,13344,13348,13344,13344,13345,13343,13338,13342,13343,13345,13352,13349,13343,13344,13343,13352,13354,13348,13344,13348,13348,13344,13353,13343,13348,13346,13345,13345,13346,13348,13351,13348,13348,13350,13352,13356,13351,13360,13354,13353,13350,13344,13348,13354,13354,13359,13353,13356,13357,13358,13358,13358,13357,13356,13357,13353,13351,13361,13355,13358,13357,13356,13357,13355,13355,13360,13360,13355,13350,13355,13356,13355,13347,13359,13350,13351,13351,13348,13355,13352,13355,13360,13344,13350,13354,13358,13345,13351,13347,13352,13353,13344,13347,13353,13351,13351,13347,13347,13346,13347,13352,13343,13347,13346,13344,13347,13346,13345,13353,13339,13341,13338,13341,13340,13341,13338,13341,13338,13341,13346,13339,13339,13336,13339,13334,13335,13338,13331,13338,13332,13328,13327,13331,13333,13334,13339,13336,13325,13322,13331,13330,13331,13334,13328,13326,13327,13323,13324,13327,13322,13322,13326,13314,13321,13326,13320,13332,13323,13316,13320,13322,13316,13323,13323,13318,13314,13316,13319,13317,13322,13315,13313,13319,13321,13320,13317,13317,13324,13317,13319,13323,13322,13324,13320,13322,13319,13323,13316,13318,13324,13327,13320,13328,13315,13317,13325,13322,13334,13320,13320,13320,13324,13322,13324,13326,13319,13317,13319,13324,13327,13320,13321,13317,13326,13325,13315,13317,13327,13319,13319,13314,13317,13315,13320,13322,13321,13321,13320,13321,13320,13321,13326,13317,13321,13318,13323,13321,13321,13323,13319,13310,13323,13317,13321,13317,13321,13317,13321,13322,13325,13320,13320,13329,13325,13321,13318,13319,13322,13322,13321,13327,13322,13318,13320,13321,13327,13328,13318,13318,13318,13320,13322,13332,13325,13321,13327,13321,13321,13324,13329,13323,13323,13324,13326,13322,13319,13323,13322,13325,13324,13323,13321,13331,13327,13323,13318,13324,13319,13321,13318,13325,13322,13326,13319,13325,13325,13329,13323,13324,13321,13321,13322,13321,13326,13318,13321,13320,13323,13319,13322,13325,13323,13320,13322,13325,13318,13320,13322,13315,13328,13320,13322,13315,13326,13327,13325,13314,13321,13317,13321,13320,13323,13324,13323,13321,13321,13318,13324,13323,13324,13326,13324,13318,13315,13332,13329,13320,13324,13318,13312,13317,13319,13327,13316,13318,13320,13318,13324,13323,13326,13323,13325,13322,13317,13322,13322,13324,13322,13315,13323,13325,13323,13325,13321,13324,13320,13325,13323,13318,13325,13331,13320,13316,13323,13321,13322,13329,13330,13330,13322,13322,13318,13332,13327,13334,13328,13325,13326,13329,13330,13325,13330,13329,13325,13329,13324,13333,13334,13331,13325,13330,13328,13331,13330,13334,13332,13331,13325,13327,13329,13327,13327,13332,13329,13327,13332,13335,13333,13339,13332,13334,13323,13336,13340,13336,13342,13331,13337,13337,13333,13332,13343,13337,13339,13343,13342,13333,13337,13342,13336,13343,13337,13342,13337,13335,13340,13341,13341,13340,13339,13336,13343,13341,13347,13340,13331,13347,13338,13338,13340,13339,13336,13334,13339,13344,13342,13335,13344,13345,13342,13347,13339,13350,13346,13351,13338,13345,13347,13344,13345,13346,13344,13345,13335,13342,13340,13345,13347,13346,13345,13351,13349,13350,13351,13353,13354,13352,13346,13348,13347,13350,13354,13353,13352,13343,13352,13357,13351,13349,13352,13347,13348,13341,13354,13347,13356,13356,13349,13356,13344,13363,13353,13356,13346,13362,13357,13347,13352,13354,13354,13354,13354,13352,13355,13355,13360,13360,13356,13356,13355,13356,13358,13357,13366,13356,13353,13358,13357,13365,13349,13353,13359,13356,13359,13362,13351,13360,13367,13362,13358,13358,13364,13366,13365,13368,13365,13365,13360,13369,13364,13365,13365,13366,13367,13364,13364,13363,13368,13367,13364,13373,13365,13372,13363,13371,13371,13370,13365,13372,13370,13370,13369,13372,13367,13371,13363,13363,13369,13378,13376,13371,13373,13368,13372,13379,13377,13372,13370,13366,13380,13376,13383,13382,13378,13371,13372,13381,13379,13379,13384,13380,13373,13376,13376,13376,13381,13380,13376,13373,13381,13379,13386,13382,13378,13384,13381,13386,13384,13374,13377,13380,13378,13384,13383,13385,13380,13386,13389,13393,13381,13384,13382,13385,13384,13383,13385,13386,13387,13387,13391,13388,13396,13385,13386,13386,13387,13387,13388,13400,13394,13392,13386,13399,13393,13396,13397,13396,13395,13394,13391,13391,13393,13398,13391,13397,13389,13394,13394,13399,13394,13395,13392,13399,13395,13397,13400,13403,13396,13394,13402,13404,13391,13404,13404,13395,13401,13393,13396,13407,13405,13405,13403,13402,13403,13402,13406,13406,13404,13401,13398,13403,13407,13405,13412,13408,13400,13402,13400,13406,13403,13404,13403,13403,13402,13404,13408,13410,13411,13408,13405,13411,13412,13411,13412,13411,13405,13417,13408,13409,13422,13417,13413,13407,13410,13413,13412,13415,13425,13411,13416,13411,13412,13415,13426,13419,13418,13413,13412,13414,13413,13418,13421,13412,13407,13403,13410,13419,13414,13418,13411,13410,13412,13413,13409,13413,13410,13411,13411,13403,13406,13403,13415,13407,13411,13410,13410,13407,13411,13410,13409,13404,13402,13406,13408,13408,13409,13406,13399,13397,13401,13406,13404,13399,13408,13400,13398,13395,13402,13395,13400,13400,13394,13390,13391,13394,13400,13391,13394,13387,13397,13389,13385,13393,13394,13395,13386,13391,13388,13392,13395,13397,13384,13392,13381,13383,13379,13382,13388,13386,13390,13384,13390,13385,13389,13385,13383,13380,13377,13384,13387,13392,13379,13391,13385,13382,13388,13389,13381,13391,13386,13391,13382,13381,13386,13389,13386,13388,13385,13394,13381,13389,13386,13388,13386,13391,13380,13386,13384,13394,13392,13380,13389,13387,13384,13390,13391,13384,13390,13389,13390,13384,13394,13388,13393,13383,13389,13393,13389,13392,13389,13388,13389,13390,13384,13385,13387,13392,13393,13390,13397,13387,13384,13392,13392,13386,13389,13393,13389,13391,13390,13397,13390,13390,13388,13393,13394,13397,13390,13389,13393,13393,13394,13395,13394,13392,13394,13390,13394,13394,13398,13394,13397,13394,13392,13385,13391,13392,13400,13394,13400,13389,13391,13394,13396,13397,13394,13391,13386,13391,13390,13393,13399,13392,13387,13393,13385,13395,13392,13397,13395,13393,13395,13387,13402,13402,13400,13403,13395,13392,13391,13393,13399,13401,13397,13393,13390,13392,13393,13392,13404,13397,13399,13394,13397,13396,13391,13400,13397,13403,13398,13398,13393,13397,13400,13397,13396,13400,13400,13397,13399,13400,13399,13397,13391,13397,13398,13402,13397,13395,13390,13391,13397,13395,13403,13404,13399,13398,13397,13392,13401,13404,13407,13385,13393,13401,13395,13395,13398,13389,13389,13402,13391,13397,13400,13402,13402,13399,13394,13396,13398,13402,13407,13400,13395,13399,13398,13399,13397,13401,13400,13399,13394,13400,13405,13400,13404,13405,13400,13396,13401,13401,13406,13403,13403,13400,13398,13407,13403,13404,13409,13407,13406,13402,13403,13408,13415,13404,13404,13405,13409,13408,13410,13408,13406,13401,13406,13407,13406,13405,13412,13412,13407,13404,13407,13411,13409,13413,13408,13409,13410,13413,13406,13420,13419,13416,13410,13412,13417,13407,13412,13418,13410,13414,13411,13410,13411,13414,13418,13418,13414,13413,13415,13413,13416,13413,13416,13413,13409,13417,13417,13414,13420,13417,13411,13414,13417,13410,13420,13416,13416,13418,13413,13414,13417,13421,13420,13415,13409,13425,13421,13414,13415,13418,13417,13414,13419,13419,13419,13424,13420,13419,13421,13420,13420,13416,13425,13421,13423,13421,13415,13423,13426,13430,13427,13417,13421,13420,13424,13424,13429,13422,13420,13416,13428,13426,13432,13433,13426,13423,13425,13424,13422,13426,13428,13431,13424,13424,13428,13427,13434,13432,13434,13428,13423,13432,13433,13430,13434,13427,13429,13427,13428,13431,13424,13446,13442,13430,13431,13435,13434,13439,13433,13427,13433,13436,13439,13436,13431,13436,13431,13425,13433,13437,13436,13435,13439,13431,13438,13440,13434,13441,13443,13440,13434,13435,13438,13434,13443,13444,13439,13434,13438,13437,13440,13444,13438,13442,13437,13441,13449,13440,13439,13449,13440,13437,13437,13438,13434,13444,13445,13441,13433,13441,13444,13450,13450,13450,13443,13444,13447,13441,13443,13442,13446,13451,13445,13440,13442};

static const struct bt_data ad[] = {
	BT_DATA_BYTES(BT_DATA_FLAGS, (BT_LE_AD_GENERAL | BT_LE_AD_NO_BREDR)),
	BT_DATA_BYTES(BT_DATA_UUID16_ALL,
		      BT_UUID_16_ENCODE(BT_UUID_BPS_VAL)),
};

void mtu_updated(struct bt_conn *conn, uint16_t tx, uint16_t rx)
{
	printk("Updated MTU: TX: %d RX: %d bytes\n", tx, rx);
}

static struct bt_gatt_cb gatt_callbacks = {
	.att_mtu_updated = mtu_updated
};

static void bt_ready(void)
{
	int err;

	printk("Bluetooth initialized\n");

	if (IS_ENABLED(CONFIG_SETTINGS)) {
		settings_load();
	}

	err = bt_le_adv_start(BT_LE_ADV_CONN_NAME, ad, ARRAY_SIZE(ad), NULL, 0);
	if (err) {
		printk("Advertising failed to start (err %d)\n", err);
		return;
	}

	printk("Advertising successfully started\n");
}

static void auth_passkey_display(struct bt_conn *conn, unsigned int passkey)
{
	char addr[BT_ADDR_LE_STR_LEN];

	bt_addr_le_to_str(bt_conn_get_dst(conn), addr, sizeof(addr));

	printk("Passkey for %s: %06u\n", addr, passkey);
}

static void auth_cancel(struct bt_conn *conn)
{
	char addr[BT_ADDR_LE_STR_LEN];

	bt_addr_le_to_str(bt_conn_get_dst(conn), addr, sizeof(addr));

	printk("Pairing cancelled: %s\n", addr);
}

static struct bt_conn_auth_cb auth_cb_display = {
	.passkey_display = auth_passkey_display,
	.passkey_entry = NULL,
	.cancel = auth_cancel,
};

void read_thread(void) {
	LOG_INF("Entering read_thread\n");
	int err = 0;
	int samples_delayed;
	uint32_t min_p, min_d;
	float ptt;
	#if !USE_TEST_DATA
	//Reset PPG sensor
	err = ppg_software_reset(spi_ppg_dist, ppg_csd);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_software_reset(spi_ppg_prox, ppg_csp);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	//Set up PPG sensor
	err = ppg_start_config(spi_ppg_dist, ppg_csd);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_start_config(spi_ppg_prox, ppg_csp);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	//Config num channels
	err = ppg_config_num_channels(spi_ppg_dist, ppg_csd);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_config_num_channels(spi_ppg_prox, ppg_csp);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	//Config LED settings and time slots
	err = ppg_config_leds(spi_ppg_dist, ppg_csd);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_config_leds(spi_ppg_prox, ppg_csp);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	//Config FIFO queue
	err = ppg_config_fifo(spi_ppg_dist, ppg_csd);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_config_fifo(spi_ppg_prox, ppg_csp);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	//Config sampling freq
	err = ppg_config_sampling_freq(spi_ppg_dist, PPG_SAMPLE_RATE, ppg_csd);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_config_sampling_freq(spi_ppg_prox, PPG_SAMPLE_RATE, ppg_csp);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	//Config GPIO outputs (mostly for debugging)
	err = ppg_config_gpios(spi_ppg_dist, ppg_csd);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_config_gpios(spi_ppg_prox, ppg_csp);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	//Extra configs for sensor tuning
	//TODO: add calibration loop for LED drive
	err = ppg_set_LED_drive(spi_ppg_dist, ppg_csd, 0, 3);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_set_LED_drive(spi_ppg_prox, ppg_csp, 0, 3);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	err = ppg_set_slot_A(spi_ppg_dist, ppg_csd, 0x04, 0x20, 0x02, 0x14);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_set_slot_A(spi_ppg_prox, ppg_csp, 0x04, 0x20, 0x02, 0x14);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	//Exit program mode
	err = ppg_exit_config(spi_ppg_dist, ppg_csd);
	if (err < 0) {
			LOG_ERR("SPI Write failed (%d)\n", err);
	}
	err = ppg_exit_config(spi_ppg_prox, ppg_csp);
	if (err < 0) {
			LOG_ERR("SPI2 Write failed (%d)\n", err);
	}
	#endif

	LOG_INF("Starting read loop\n");
	//Read from PPG Sensor
	while (err == 0) {
		#if !USE_TEST_DATA
		LOG_INF("Reading...\n");
		err = ppg_read_sensors(spi_ppg_dist, spi_ppg_prox, ppg_csd, ppg_csp, proximal, distal , PPG_ARRAY_SIZE);
		if (err < 0) {
			LOG_ERR("SPI Read failed (%d)\n", err);
		}
		/*
		for (int i = 0; i < PPG_ARRAY_SIZE; i++) {
			printf("%d,", proximal[i]);
		}
		printf("\n.\n");
		for (int i = 0; i < PPG_ARRAY_SIZE; i++) {
			printf("%d,", distal[i]);
		}
		printf("\n\n");*/
		#endif

		LOG_INF("Calculating...");
		//Process raw signal
		//TODO: add better signal processing lol
		min_p = proximal[0];
		min_d = distal[0];
		for (int i = 1; i < PPG_ARRAY_SIZE; i++) {
			if (proximal[i] < min_p){
				min_p = proximal[i];
			}
			if (distal[i] < min_d){
				min_d = distal[i];
			}
		}
		for (int i = 1; i < PPG_ARRAY_SIZE; i++) {
			proximal[i] = proximal[i] - min_p;
			distal[i] = distal[i] - min_d;
		}

		//Cross correlate the proximal and distal data
		samples_delayed = cross_correlate(proximal, distal, PPG_ARRAY_SIZE, MAX_PTT);

		LOG_INF("Delay: %d", samples_delayed);
		//calculate the ptt based on the sample rate and peak location
		ptt = ((float) samples_delayed / (float) PPG_SAMPLE_RATE);

		bt_bps_notify(samples_delayed, 1);
		k_msleep(SENSOR_SLEEP_MS);
	}

	//If an error occurs, break loop
	//TODO: add better error handling
	LOG_ERR("err = %d\n", err);

	while (1) {
		k_msleep(SENSOR_SLEEP_MS);
	}
}

int main(void) {

	int err;
	//Configure GPIOS
	LOG_INF("Configuring GPIO pins\n");
	if (!device_is_ready(ppg_csd.port)) {
		LOG_ERR("GPIO device is not ready");
		return 0;
	}
	err = gpio_pin_configure_dt(&ppg_csd, GPIO_OUTPUT_INACTIVE);
	if (!device_is_ready(ppg_csp.port)) {
		LOG_ERR("GPIO device is not ready");
		return 0;
	}
	err = gpio_pin_configure_dt(&ppg_csp, GPIO_OUTPUT_INACTIVE);

	//Configure SPI
	LOG_INF("Configuring SPI\n");
    if (!spi_is_ready_dt(&spi_ppg_dist)) {
        LOG_ERR("SPI device not ready, aborting\n");
		return 0;
	}
	if (!spi_is_ready_dt(&spi_ppg_prox)) {
        LOG_ERR("SPI device not ready, aborting\n");
		return 0;
	}

	//Enable BLE
	err = bt_enable(NULL);
	if (err) {
		LOG_ERR("Bluetooth init failed (err %d)\n", err);
		return 0;
	}
	//Start BLE advertising
	bt_ready();
	bt_gatt_cb_register(&gatt_callbacks);
	bt_conn_auth_cb_register(&auth_cb_display);
}

//Initialize the threads
K_THREAD_DEFINE(rd_thread, STACKSIZE*2, read_thread, NULL, NULL, NULL, 
                READ_THREAD_PRIORITY, 0, 0); 
//K_THREAD_DEFINE(cal_thread, STACKSIZE, calc_thread, NULL, NULL, NULL, 
                //CALC_THREAD_PRIORITY, 0, 0);


